{%- comment -%}
  Lazy CSS Loader Snippet
  Usage: {% render 'lazy-css', filename: 'section-main-product.css', loading: 'preload' %}

  Parameters:
  - filename: CSS file name (required)
  - loading: Loading strategy (optional, default: 'low')
    - 'preload': High priority loading
    - 'low': Async loading with print media trick (DEFAULT)
    - 'lazy': Load on user interaction
  - media: Media query (optional, default: 'all')
{%- endcomment -%}

{%- liquid
  assign css_url = filename | asset_url
  assign media_query = media | default: 'all'
  assign loading_strategy = loading | default: 'low'
-%}

{%- case loading_strategy -%}
  {%- when 'preload' -%}
    {{ css_url | stylesheet_tag: preload: true }}

  {%- when 'low' -%}
    <link
      rel="stylesheet"
      href="{{ css_url }}"
      media="print"
      onload="this.onload=null;this.media='{{ media_query }}';"
    >
    <noscript><link rel="stylesheet" href="{{ css_url }}" media="{{ media_query }}"></noscript>

  {%- when 'lazy' -%}
    <script>
      (function () {
        function addToQueue() {
          if (window.lazyResources && typeof window.lazyResources.addCSS === 'function') {
            window.lazyResources.addCSS('{{ css_url }}', 'low');
          } else {
            setTimeout(addToQueue, 50);
          }
        }
        addToQueue();
      })();
    </script>
    <noscript><link rel="stylesheet" href="{{ css_url }}" media="{{ media_query }}"></noscript>

  {%- else -%}
    <link rel="stylesheet" href="{{ css_url }}" media="{{ media_query }}">
{%- endcase -%}
