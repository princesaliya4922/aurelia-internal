{% render 'lazy-css', filename: 'otp-overlay.css', loading: 'preload' %}

<div class="otp_overlay">
  <div class="main_otp_container">
    <div class="main_otp_container_inner">
      <div class="otp_pop_heading">
        <span class="font-medium">LOGIN</span>
        <a class="close_otp" href="#">&times;</a>
      </div>
      <form class="login-form">
        <div class="field-mobile">
          <label class="label">
            <span>Mobile Number</span>
          </label>
          <input
            maxlength="10"
            autocomplete="off"
            name="mobile"
            autofocus="autofocus"
            class="input-text form-control cstm__phone"
            _cl_tracker_added_cl7466="true"
          >
          <p class="size_error phone"></p>
        </div>

        <div class="field_otp">
          <label class="label">
            <span>One Time Password(OTP)</span>
          </label>
          <input
            maxlength="6"
            type="text"
            name="customerpassword"
            disabled="disabled"
            autocomplete="off"
            class="input-text form-control cstm__otp"
          >
          <p class="size_error otp"></p>
          <label class="timer-main font-medium">
            <span>Please enter the OTP sent on your Mobile</span>
            <a href="#" id="resend" class="action otp-resend-button"><span>Resend OTP </span></a>
            <span class="timer-container" id="resendcountdown">00:60</span>
          </label>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let register = false;
  let countdown;

  // Utility functions
  const removeMessages = () => {
    document.querySelectorAll('.error_message, .success_message').forEach(el => el.remove());
  };

  const showMessage = (message, type = 'error') => {
    removeMessages();
    const heading = document.querySelector('.otp_pop_heading');
    if (heading) {
      heading.insertAdjacentHTML('beforebegin', `<div class="${type}_message">${message}</div>`);
    }
  };

  const showOverlay = () => {
    const overlay = document.querySelector('.otp_overlay');
    if (overlay) overlay.style.display = 'block';
  };

  const hideOverlay = () => {
    const overlay = document.querySelector('.otp_overlay');
    if (overlay) overlay.style.display = 'none';
  };

  // Close OTP overlay
  document.addEventListener('click', function(e) {
    if (e.target.matches('.close_otp')) {
      hideOverlay();
      localStorage.setItem("manage-order", "");
    }
  });

  // Account icon click handler
  document.addEventListener('click', function(e) {
    if (e.target.matches('.header__icon--account')) {
      {% unless customer %}
        e.preventDefault();
        showOverlay();
      {% endunless %}
    }
  });

  // Phone number input handler
  const phoneInput = document.querySelector('.cstm__phone');
  if (phoneInput) {
    phoneInput.addEventListener('input', function(e) {
      register = false;
      removeMessages();
      
      const val = this.value;
      const phoneError = document.querySelector('.size_error.phone');
      
      if (val.length === 10) {
        e.preventDefault();
        this.disabled = true;
        
        if (phoneError) phoneError.textContent = '';
        
        if (val.startsWith("1") || val.startsWith("2") || val.startsWith("3") || val.startsWith("4")) {
          showMessage('The phone must start with one of the following: 5, 6, 7, 8, 9');
          this.disabled = false;
          return;
        }
        
        sendOTP(val, 1);
      } else {
        if (phoneError) {
          phoneError.textContent = 'Please enter valid mobile number';
          phoneError.style.color = 'red';
        }
      }
    });
  }

  // OTP resend button handler
  document.addEventListener('click', function(e) {
    if (e.target.matches('.otp-resend-button')) {
      const phoneInput = document.querySelector('.cstm__phone');
      const val = phoneInput ? phoneInput.value : '';
      
      if (val.length === 10) {
        phoneInput.disabled = true;
        
        if (val.startsWith("1") || val.startsWith("2") || val.startsWith("3") || val.startsWith("4")) {
          showMessage('The phone must start with one of the following: 5, 6, 7, 8, 9');
          phoneInput.disabled = false;
          return;
        }
        
        sendOTP(val, 1);
      } else {
        const phoneError = document.querySelector('.size_error.phone');
        if (phoneError) {
          phoneError.textContent = 'Please enter valid mobile number';
          phoneError.style.color = 'red';
        }
      }
    }
  });

  // OTP input handler
  const otpInput = document.querySelector('.cstm__otp');
  if (otpInput) {
    otpInput.addEventListener('input', function(e) {
      const phoneInput = document.querySelector('.cstm__phone');
      const val = phoneInput ? phoneInput.value : '';
      const otp = this.value;
      
      if (otp.length === 6) {
        e.preventDefault();
        this.disabled = true;
        
        if (register) {
          verifyRegisterOtp(val, otp);
        } else {
          verifyOTP(val, otp);
        }
      }
    });
  }

  // Send OTP function
  async function sendOTP(val, time) {
    removeMessages();
    
    try {
      const response = await fetch('https://shopify.shopforaurelia.com/otp/shopforaurelia/login/sendotp', {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          "mobileNumber": val
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        showMessage(data.message, 'success');
        
        const otpInput = document.querySelector('.cstm__otp');
        if (otpInput) {
          otpInput.disabled = false;
          otpInput.focus();
        }
        
        if (time === 0) {
          const resendButton = document.querySelector('.otp-resend-button');
          if (resendButton) resendButton.style.display = 'block';
        } else {
          timer(60);
        }
      } else {
        if (data.message.toLowerCase().includes("you are not a registered") || 
            data.message.toLowerCase().includes("please create a new account")) {
          registerOtp(val, time);
        } else {
          showMessage(data.message);
        }
      }
    } catch (error) {
      console.error("Error: ", error);
      showMessage("An error occurred. Please try again.");
    } finally {
      const phoneInput = document.querySelector('.cstm__phone');
      if (phoneInput) phoneInput.disabled = false;
    }
  }

  // Verify OTP function
  async function verifyOTP(val, otp) {
    removeMessages();
    
    try {
      const response = await fetch('https://shopify.shopforaurelia.com/otp/shopforaurelia/login/verifyotp', {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          "mobileNumber": val,
          "otp": otp
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        showMessage(data.message, 'success');
        window.location.href = data.url;
      } else {
        showMessage(data.message);
      }
    } catch (error) {
      console.error("Error: ", error);
      showMessage("An error occurred. Please try again.");
    } finally {
      const otpInput = document.querySelector('.cstm__otp');
      if (otpInput) otpInput.disabled = false;
    }
  }

  // Register OTP function
  async function registerOtp(val, time) {
    register = true;
    removeMessages();
    
    try {
      const response = await fetch('https://shopify.shopforaurelia.com/otp/shopforaurelia/register/sendotp', {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          "mobileNumber": val
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        showMessage(data.message, 'success');
        
        const otpInput = document.querySelector('.cstm__otp');
        if (otpInput) {
          otpInput.disabled = false;
          otpInput.focus();
        }
        
        if (time === 0) {
          const resendButton = document.querySelector('.otp-resend-button');
          if (resendButton) resendButton.style.display = 'block';
        } else {
          timer(60);
        }
      } else {
        showMessage(data.message);
      }
    } catch (error) {
      console.error("Error: ", error);
      showMessage("An error occurred. Please try again.");
    } finally {
      const phoneInput = document.querySelector('.cstm__phone');
      if (phoneInput) phoneInput.disabled = false;
    }
  }

  // Verify register OTP function
  async function verifyRegisterOtp(val, otp) {
    removeMessages();
    
    try {
      const response = await fetch('https://shopify.shopforaurelia.com/otp/shopforaurelia/register/verifyotp', {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          "mobileNumber": val,
          "otp": otp,
          "first_name": "",
          "last_name": ""
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        showMessage(data.message, 'success');
        window.location.href = data.url;
      } else {
        showMessage(data.message);
      }
    } catch (error) {
      console.error("Error: ", error);
      showMessage("An error occurred. Please try again.");
    } finally {
      const otpInput = document.querySelector('.cstm__otp');
      if (otpInput) otpInput.disabled = false;
    }
  }

  // Timer function
  function timer(seconds) {
    clearInterval(countdown);
    const now = Date.now();
    const then = now + seconds * 1000;
    
    displayTimeLeft(seconds);
    
    countdown = setInterval(() => {
      const secondsLeft = Math.round((then - Date.now()) / 1000);
      
      if (secondsLeft < 0) {
        clearInterval(countdown);
        
        const resendButton = document.querySelector('.otp-resend-button');
        const timerContainer = document.querySelector('.timer-container');
        
        if (resendButton) resendButton.style.display = 'block';
        if (timerContainer) timerContainer.style.display = 'none';
        
        return;
      } else {
        const resendButton = document.querySelector('.otp-resend-button');
        const timerContainer = document.querySelector('.timer-container');
        
        if (resendButton) resendButton.style.display = 'none';
        if (timerContainer) timerContainer.style.display = 'block';
      }
      
      displayTimeLeft(secondsLeft);
    }, 1000);
  }

  // Display time left function
  function displayTimeLeft(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainderSeconds = seconds % 60;
    const display = `${minutes}:${remainderSeconds < 10 ? '0' : ''}${remainderSeconds}`;
    
    const counter = document.getElementById("resendcountdown");
    if (counter) {
      counter.innerHTML = display;
    }
  }
});
</script>
